# Ошибки методов Рунге-Кутты

Рассмотрим один из методов Рунге-Кутты.

### Общий явный метод Рунге-Кутты 2-го порядка

Таблица Бутчера для метода:

<img src=".\sources\LETI11\butcher.png" alt="butcher" style="zoom:25%;" />

Коэффициенты рассчитываются следующим образом:

<img src=".\sources\LETI11\k12.png" alt="k12" style="zoom:25%;" />

В методе средней точки, который является частным случаем общего метода, $\alpha = 1/2$.

Формула для $\mathbf{x}(t+h)$:

<img src=".\sources\LETI11\xth.png" alt="xth" style="zoom:25%;" />																(1)

Используем разложение в ряд Тейлора для коэффициентов:

<img src=".\sources\LETI11\k12_2.png" alt="k12_2" style="zoom:25%;" />

Также разложим в ряд Тейлора $\mathbf{x}(t+h)$:

<img src=".\sources\LETI11\xth_2.png" alt="xth_2" style="zoom:25%;" />                 																(2)

Приравнивая (1) и (2), можно составим СЛАУ с неизвестными $b_1, b_2$

<img src=".\sources\LETI11\b12.png" alt="b12" style="zoom:25%;" />

Решение этой системы уравнений:

<img src=".\sources\LETI11\b12_2.png" alt="b12_2" style="zoom:25%;" />

Таким образом, явных методов Рунге-Кутты 2-го порядка может быть бесконечно много, а их многообразие определяется различным выбором значения $\alpha$.

Таблицу Бутчера в таком случае можно записать, используя только $\alpha$:

<img src=".\sources\LETI11\generic.png" alt="generic" style="zoom:25%;" />

#### Примеры

<img src=".\sources\LETI11\alpha1.png" alt="alpha1" style="zoom:25%;" /> – Метод Хойна

<img src=".\sources\LETI11\alpha12.png" alt="alpha12" style="zoom:25%;" /> – Метод средней точки

#### Оценка ошибки

Используем разложение в ряд Тейлора для коэффициентов $\mathbf{k_1}, \mathbf{k_2}$ до второго члена ряда:
<img src=".\sources\LETI11\k12_3.png" alt="k12_3" style="zoom:25%;" />

С учетом таких разложений коэффициентов запишем уравнение для $\mathbf{x}(t+h)$:

<img src=".\sources\LETI11\xth_3.png" alt="xth_3" style="zoom:25%;" />													(3)

Сопоставим полученное уравнение с разложением в ряд Тейлора до 3-го члена:

<img src=".\sources\LETI11\xth_4.png" alt="xth_4" style="zoom:25%;" />											(4)

Четвертый член суммы отличается, соответственно, имеет место ошибка, которая определяется вычитанием (3) из (4):

<img src=".\sources\LETI11\eps.png" alt="eps" style="zoom:25%;" />

Итак, выбором $\alpha$ можно уменьшить значение ошибки, так как первый член суммы зависит от $\alpha$. Несложно увидеть, что при выборе $\alpha = 2/3$, то первый член суммы станет равен 0.

Метод с таким $\alpha$ называется методом Ралстона, его таблица Бутчера:

<img src=".\sources\LETI11\alpha23.png" alt="alpha23" style="zoom:25%;" />

Ошибка метода Ралстона с учетом некоторых ограничений на функцию:

<img src=".\sources\LETI11\chml.png" alt="chml" style="zoom:25%;" />

### Аналитические оценки ошибок методов Рунге-Кутты

Если <img src=".\sources\LETI11\ml.png" alt="ml" style="zoom:25%;" />, то как раз выполняются условия $||\mathbf{f}||<M, ||\mathbf{f}'||<L$. 

В общем говоря, если найдены такие $M,L$, что данное неравенство выполняется, то для метода Рунге-Кутты порядка $p$:

<img src=".\sources\LETI11\eps2.png" alt="eps2" style="zoom:25%;" />

#### Примеры

Возьмем классический метод Рунге-Кутты 4-го порядка с таблицей Бутчера:

<img src=".\sources\LETI3\butcher-rk4.png" alt="butcher-rk4" style="zoom:30%;" />

Рассчитаем константу $C$:

<img src=".\sources\LETI11\C1.png" alt="C1" style="zoom:25%;" />

Для метода 3/8 с таблицей Бутчера:

<img src=".\sources\LETI3\butcher-rk38.png" alt="butcher-rk38" style="zoom:30%;" />

<img src=".\sources\LETI11\C2.png" alt="C2" style="zoom:25%;" />

Метод Ралстона 4-го порядка с таблицей Бутчера:

<img src=".\sources\LETI3\butcher-ralston4.png" alt="butcher-ralston4" style="zoom:30%;" />

Имеет минимально возможное для методов Рунге-Кутты значение $C$:

<img src=".\sources\LETI11\C3.png" alt="C3" style="zoom:25%;" />

Отметим, что данная оценка ошибки не использует реальные значения функции, поэтому настоящая ошибка может быть значительно меньше этой оценки. Метод, который оптимален с точки зрения константы $C$ может оказаться менее оптимальным на практике.

Попробуем оценивать ошибку, исходя из значений, рассчитанных по ходу работы метода.

### Вложенные методы Рунге-Кутты

Данные методы – некоторое расширение обычных методов Рунге-Кутты. Для их определения в таблицу Бутчера добавляется строка с другими коэффициентами $\hat{b}_i$:

<img src=".\sources\LETI11\nested.png" alt="nested" style="zoom:25%;" />

Соответственно, $\mathbf{x}(t+h)$ вычисляется двумя способами:

<img src=".\sources\LETI11\xth_5.png" alt="xth_5" style="zoom:25%;" />

<img src=".\sources\LETI11\xth_6.png" alt="xth_6" style="zoom:25%;" />

Таким образом, в методе совмещается два обычных метода. Как правило, при этом порядки $p, \hat{p}$ отличаются на 1.

Теперь можно рассчитать оценку ошибки, вычитая уравнения:

<img src=".\sources\LETI11\bibi.png" alt="bibi" style="zoom:25%;" />

Таким образом можно получать оценку той ошибки, которую мы хотим контролировать.

Для $p, \hat{p}$ метод называется вложенным методом порядка $p(\hat{p})$, где $p$ – порядок аппроксимации значения на следующем шаге, а $\hat{p}$ используется именно для оценки ошибки.

### Примеры

Метод Хойна-Эйлера 2(1). Число вычислений в правой части на каждом шаге $s=2$.

<img src=".\sources\LETI3\embedded-12.png" alt="embedded-12" style="zoom:25%;" />

Метод Богацкого-Шампина 3(2), $s=4$.  FSAL (first same as last) – наличие у метода повторяющихся строк в таблице Бутчера позволяет использовать по 3 вызова правой части на шаг.

<img src=".\sources\LETI11\bogacki.png" alt="bogacki" style="zoom:25%;" />

Еще несколько вложенных методов:

* Метод Рунге-Кутты-Фельберга 4(5), $s=6$

* Метод Дормана-Принса 5(4), $s=7$, FSAL

### Подбор шага

Шаг можно не держать постоянным на всем промежутке интегрирования, а увеличивать его или уменьшать с тем, чтобы ошибка держалась в требуемых пределах.

<img src=".\sources\LETI11\xnp1.png" alt="xnp1" style="zoom:25%;" />

Оценка ошибки в этом случае может считаться так:

<img src=".\sources\LETI11\eps3.png" alt="eps3" style="zoom:25%;" />

Задача: управлять шагом так, чтобы значение $\varepsilon$ не стало слишком большим.

Должно быть

<img src=".\sources\LETI11\atolrtol.png" alt="atolrtol" style="zoom:25%;" />

Ошибка разделяется на две компоненты: абсолютную $\mathrm{Atol}_i$ и относительную (второй член суммы). Относительная ошибка умножается на максимальное значение из $|\hat{x}_i^{(n+1)}|, |x_i^{(n+1)}|$, так как может произойти так, что одно из значений станет равно 0.

Абсолютные и относительные допуски $\mathrm{Atol}_i и$ $\mathrm{Rtol}_i$ задаются пользователем, это пределы, в которых должна держаться ошибка.

Если оценка ошибки больше допустимого, можно, например, делить шаг пополам, а если наоборот слишком маленькая, то увеличивать. Такой способ не самый оптимальный.

Оптимальный выбор шага заключается в рассмотрении выражения:

<img src=".\sources\LETI11\err.png" alt="err" style="zoom:25%;" />

Данная величина асимптотически пропорциональная шагу в степени, наименьшей из $p, \hat{p}$. Пользуясь этим, можно подогнать $\mathrm{err}$ к 1. Для этого выбирается оптимальный шаг:

<img src=".\sources\LETI11\hopt.png" alt="hopt" style="zoom:25%;" />

Таким образом, очередной шаг можно провести со значением оптимального шага, вновь посчитать ошибку, и велика вероятность, что она уже будет укладываться в заданные допуски.