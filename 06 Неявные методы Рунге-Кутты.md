# Неявные методы Рунге-Кутты

Неявные методы Рунге-Кутты применяются для так называемых «жестких» систем ОДУ — системы, в которых применение явных методов Рунге-Кутты приводит к проблемам с устойчивостью.

### Общий вид неявных методов Рунге-Кутты

При вычислении правых частей $\mathbf{k}_i$ могут использоваться все $\mathbf{k}_j, j=1..s$:
$$
\mathbf{k}_i = \mathbf{f}\left(\mathbf{x}(t) + h \sum\nolimits_{j=1}^s a_{ij}\mathbf{k}_j\right), \quad i = 1..s
$$
Значение вектора состояния на следующем шаге:
$$
\mathbf{x}(t+h) = \mathbf{x}(t) + h\sum\limits_{i=1}^{s}{b}_{i}\mathbf{k}_i \ [\ +\ {\varepsilon}]
$$
Данное выражение является аппроксимацией с некоторой ошибкой $\varepsilon$.

В связи с тем, что $\mathbf{k}_i$ нельзя найти по явным формулам, для их нахождения рекомендуются методы нахождения корней уравнений: метод простой итерации, метод Ньютона.

Для краткой записи неявных методов Рунге-Кутты, как и для явных, используются таблицы Бутчера. Общий вид таблицы:
$$
\begin{array}{|cccc} 
    a_{11}    & a_{12} & \dots & a_{1s}\\
    a_{21}     & a_{22} & \dots & a_{2s}\\
     \vdots     & \vdots     &  \ddots  & \vdots \\
     a_{s1}     & a_{s2}   &   \dots    & a_{ss} \\
    \hline
     b_1        & b_2       &  \dots     & b_s\\

  \end{array}
$$

### Неявный метод Эйлера

Неявный метод Эйлера также называют обратным, а явный — прямым.

Таблица Бутчера для метода:
$$
\begin{array}{|c} 
    1\\
    \hline
1\\
  \end{array}
$$
Формула для $\mathbf{x}(t+h)$:
$$
\mathbf{x}(t+h) = \mathbf{x}(t) + h\mathbf{f}(\mathbf{x}(t+h)) + O(h^2)
$$
Несложно увидеть, что если рассмотреть уравнение как разложение в ряд Тейлора функции $\mathbf{x}$ в окрестности точки $t+h$, то значение в точке $t$ именно так и будет выражаться с ошибкой $O(h^2)$ или $o(h)$. Метод имеет порядок 1.

#### Пример

Рассмотрим динамическую систему с уравнением $f(x)=-kx$. Задача Коши данной системы имеет тривиальное математическое решение вида $x(t)=x_0 e^{-k/t}$. Отобразим фазовый портрет данной системы:

<img src=".\sources\LETI10\exp.png" alt="exp" style="zoom:50%;" />

По оси абсцисс — время $t$, по оси ординат — $x$. Здесь отображены кривые математического решения при разном значении $x_0$. 

Обратим внимание, что это уравнение имеет решение и в отрицательной области. Смены знака $x$ не должно происходить, но в численном методе это случается. 

Например, в явном методе Эйлера при выборе большого шага, например $h=2, x_0=1$. Производная при $t=0$ равна $-1$, соответственно,  после первого шага метод окажется в точке $(2, -1)$. В дальнейшем метод будет «прыгать» между разными по знаку и одинаковыми по величине $x$ и никогда не придет к $x=0$. На графике поведение метода при данном шаге изображено оранжевой ломаной.

Если выбрать шаг $h=3$, то метод после первого шага окажется в точке $(2, -2)$, и далее значения $x_i$ будут не только постоянно менять знак, но еще и становиться больше по модулю, то есть метод разойдется, траектория получится осциллирующей. Так и проявляется неустойчивость прямого метода Эйлера на этой задаче. Задача является жесткой и в ней стоит использовать неявный метод Эйлера. На графике поведение метода при данном шаге изображено зеленой ломаной.

В случае, если при том же $x_0=1$ брать шаг $h<2$, то явный метод сойдется:
$$
x(t + h) \approx x(t)(1 - kh) \\

x(t) \approx x(0)(1-kh)^{t/h}
$$
Таким образом, метод сходится при $|1-kh|<1$.

Неявный метод Эйлера вне зависимости от выбора шага не уйдет в отрицательную область и на каждом шаге будет получаться значение меньше значения на предыдущем.
$$
x(t+h) \approx x(t) / (1 + kh) \\

x(t) \approx x(0) (1 + kh)^{-t/h}
$$
Метод сходится при $k>0, h>0$

На графике поведение метода при данном шаге изображено фиолетовой ломаной.

### Неявный метод средней точки

Таблица Бутчера для метода:
$$
\begin{array}{|c} 
    1/2\\
    \hline
1\\
  \end{array}
$$
Уравнение для коэффициента $\mathbf{k}_1$:
$$
\mathbf{k}_1 = \mathbf{f}\left(\mathbf{x}(t) + \frac{h}{2}\mathbf{k}_1\right)
$$
Формула для $x(t+h)$:
$$
\mathbf{x}(t+h) = \mathbf{x}(t) + h\mathbf{k}_1 + o(h^2)
$$
Разложим в ряд Тейлора выражение для $\mathbf{k}_1$:
$$
\begin{array}{lcl}
\mathbf{k_1} &=& \mathbf{f}(\mathbf{x}) + \frac{h}{2}\mathbf{f}'(\mathbf{x})\mathbf{k}_1 + O(h^2) \\
  &= & \mathbf{f}(\mathbf{x}) + \frac{h}{2}\mathbf{f}'(\mathbf{x})(\mathbf{f}(\mathbf{x}) + O(h)) \\
  &= & \mathbf{f}(\mathbf{x}) + \frac{h}{2}\mathbf{f}'(\mathbf{x})\mathbf{f}(\mathbf{x}) + O(h^2)\\
\end{array}
$$
Сопоставим с разложением $\mathbf{x}(t+h)$ в ряд Тейлора в окрестности точки $t+h$:
$$
\begin{array}{lcl}
\mathbf{x}(t+h) &=& \mathbf{x}(t) + h \mathbf{\dot x}(t) + \frac{h^2}{2} \mathbf{\ddot x}(t) + o(h^2) \\
  &=& \mathbf{x}(t) + h \mathbf{f}(\mathbf{x}(t)) + \frac{h^2}{2} \mathbf{f'}(\mathbf{x}(t)) \mathbf{f}(\mathbf{x}(t)) + o(h^2) \\
  &=& \mathbf{x}(t) + h \mathbf{k}_1 + o(h^2)
\end{array}
$$
Это доказывает, что метод имеет порядок 2.

### Метод неявных трапеций

Таблица Бутчера для метода:
$$
\begin{array}{|cc} 
    0   & 0 \\
    1/2 & 1/2\\
    \hline
     1/2 & 1/2\\
  \end{array}
$$
Уравнения для коэффициентов:
$$
\begin{array}{ll}
 \mathbf{k}_1 =& \mathbf{f}(\mathbf{x}(t)) \\
 \mathbf{k}_2 =& \mathbf{f}(\mathbf{x}(t) + \frac{h}{2}(\mathbf{k}_1 + \mathbf{k}_2))\\
\end{array}
$$
Формула для $x(t+h)$:
$$
\mathbf{x}(t+h) = \mathbf{x}(t) + \frac{h}{2}(\mathbf{k}_1 + \mathbf{k}_2)
$$
Покажем, что метод имеет порядок 2, используя разложение в ряд Тейлора:
$$
\begin{array}{lcl}
\frac{1}{2}(\mathbf{k_1} + \mathbf{k_2})  &=& \mathbf{f}(\mathbf{x}(t)) + \frac{h}{4}\mathbf{f}'(\mathbf{x}(t))(\mathbf{k}_1 + \mathbf{k}_2) + O(h^2) \\
  &= & \mathbf{f}(\mathbf{x}(t)) + \frac{h}{4}\mathbf{f}'(\mathbf{x}(t))(2\mathbf{f}(\mathbf{x}(t)) + O(h)) + O(h^2) \\
  &= & \mathbf{f}(\mathbf{x}(t)) + \frac{h}{2}\mathbf{f}'(\mathbf{x}((t))\mathbf{f}(\mathbf{x}(t)) + O(h^2)\\
\end{array}
$$
Далее доказательство аналогично доказательству порядка неявного метода средней точки.

### Другие неявные одношаговые методы

Большая часть более интересных методов основана на аппроксимации функции правой части некоторым многочленом, построенным по значениям $f$ на некоторой сетке точек, и дальнейшем интегрировании этого многочлена с целью получения следующего вектора состояния системы. В зависимости от вида сетки точек более продвинутые методы распадаются на три вида:

* Методы Лобатто (порядки 2, 4, 6)
* Методы Радо (RADAU)
  * Метод Эверхарта до 15-го порядка (изначально создан для интегрирования систем небесной механики)
* Методы Гаусса-Лежандра
  * Метод Гаусса-Эверхарта (GAUSS15) до 15-го порядка

Применение того или иного метода сильно зависит от задачи и от того, как данный метод хорошо или плохо на данной задаче аппроксимирует решение, насколько хорошо сходится. Немаловажным является то, насколько требователен метод к вычислительным ресурсам. Неявные методы в целом намного более требовательны к ним, чем явные, так как на каждом шаге необходимо решать некоторую систему уравнений.

